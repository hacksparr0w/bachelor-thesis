variable num_atoms getenv "MD_NUM_ATOMS"
variable output_file getenv "MD_OUTPUT_FILE"

units metal
atom_style atomic
boundary p p p

kim init &
  Sim_LAMMPS_ModifiedTersoff_PurjaPunMishin_2017_Si__SM_184524061456_000 &
  metal

variable silicon_atom_weight equal 28.0855
variable silicon_density equal 2.329002

variable box_volume equal ${num_atoms}*${silicon_atom_weight}*1.66053907/${silicon_density}

variable box_size equal ${box_volume}^(1/3)

region box block 0 ${box_size} 0 ${box_size} 0 ${box_size}
create_box 1 box
create_atoms 1 random ${num_atoms} 97893303 box

kim interactions Si
neigh_modify every 1 check yes
mass 1 ${silicon_atom_weight}

compute atom_potential_energy all pe/atom
compute total_potential_energy all reduce sum c_atom_potential_energy

timestep 0.0005
thermo 100
thermo_style custom step temp pe etotal press c_total_potential_energy

velocity all create 4000 32222 mom yes rot yes dist gaussian
fix 1 all npt temp 4000 4000 $(100.0 * dt) iso 0 0 $(1000.0 * dt)
run 1000000
unfix 1

fix 2 all npt temp 4000 1e-10 $(100.0 * dt) iso 0 0 $(1000.0 * dt)
run 10000000
unfix 2

velocity all set 0 0 0

min_style cg
minimize 1e-10 1e-10 500000 500000

variable total_potential_energy equal c_total_potential_energy
variable total_atoms equal "count(all)"
variable cohesive_energy equal "v_total_potential_energy / v_total_atoms"
variable final_volume equal "vol / v_total_atoms"

print "Total energy (eV) = ${total_potential_energy}"
print "Cohesive energy (eV) = ${cohesive_energy}"
print "Final volume (angstrom^3) = ${final_volume}"

write_data ${output_file}
write_dump all xyz system.xyz
